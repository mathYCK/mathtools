<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸å­¸å–®å…ƒ 3-2 åå­—äº¤ä¹˜æ³• (å«AIå®¶æ•™)</title>
    
    <!-- å¼•å…¥ Tailwind CSS (æ¨£å¼åº«) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ React å’Œ ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- å¼•å…¥ Babel (è®“ç€è¦½å™¨çœ‹ä¸æ‡‚çš„ JSX èªæ³•å¯ä»¥åŸ·è¡Œ) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* ç¢ºä¿åœ¨éƒ¨è½æ ¼ä¸­åµŒå…¥æ™‚æœ‰è¶³å¤ çš„é«˜åº¦ */
        #root {
            width: 100%;
            height: 600px; /* æ‚¨å¯ä»¥ä¾éœ€æ±‚èª¿æ•´é«˜åº¦ */
            overflow: hidden;
            position: relative;
        }
        /* é¿å…èˆ‡éƒ¨è½æ ¼åŸæœ¬çš„æ¨£å¼è¡çªï¼Œé‡ç½®ä¸€äº›åŸºç¤è¨­å®š */
        .lesson-container {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.5;
        }
        
        /* ç°¡å–®çš„å°è©±æ¡†å‹•ç•« */
        @keyframes popIn {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .chat-pop {
            animation: popIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
        }
    </style>
</head>
<body>

    <!-- æ‡‰ç”¨ç¨‹å¼æ›è¼‰é» -->
    <div id="root"></div>

    <!-- React ç¨‹å¼é‚è¼¯ -->
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- å…§åµŒ SVG åœ–ç¤ºå…ƒä»¶ ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {children}
            </svg>
        );

        const ArrowRight = (props) => (
            <IconWrapper {...props}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></IconWrapper>
        );

        const ArrowLeft = (props) => (
            <IconWrapper {...props}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></IconWrapper>
        );

        const Check = (props) => (
            <IconWrapper {...props}><polyline points="20 6 9 17 4 12"/></IconWrapper>
        );

        const X = (props) => (
            <IconWrapper {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconWrapper>
        );

        const RefreshCw = (props) => (
            <IconWrapper {...props}><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></IconWrapper>
        );

        const BookOpen = (props) => (
            <IconWrapper {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconWrapper>
        );

        const Calculator = (props) => (
            <IconWrapper {...props}><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="16" y1="18" x2="16" y2="18"/><line x1="8" y1="18" x2="8" y2="18"/><line x1="12" y1="18" x2="12" y2="18"/></IconWrapper>
        );

        const Edit3 = (props) => (
            <IconWrapper {...props}><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></IconWrapper>
        );

        const HelpCircle = (props) => (
            <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconWrapper>
        );

        const MessageCircle = (props) => (
            <IconWrapper {...props}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></IconWrapper>
        );
        
        const Bot = (props) => (
            <IconWrapper {...props}><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></IconWrapper>
        );

        const Send = (props) => (
             <IconWrapper {...props}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></IconWrapper>
        );

        // --- AI å®¶æ•™å…ƒä»¶ ---
        const AITutor = () => {
            const [isOpen, setIsOpen] = useState(false);
            const [messages, setMessages] = useState([
                { type: 'bot', text: 'å—¨ï¼æˆ‘æ˜¯ä½ çš„æ•¸å­¸å°å®¶æ•™ ğŸ¤–\né—œæ–¼åå­—äº¤ä¹˜ï¼Œæœ‰ä»€éº¼è®“ä½ é ­ç—›çš„åœ°æ–¹å—ï¼Ÿ' }
            ]);
            const [inputValue, setInputValue] = useState("");
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages, isOpen]);

            // é è¨­å•é¡Œåº«
            const quickQuestions = [
                "ç¬¦è™Ÿæ€éº¼åˆ¤æ–·ï¼Ÿ",
                "ä¿‚æ•¸ä¸æ˜¯ 1 æ€éº¼è¾¦ï¼Ÿ",
                "ä¸€ç›´è©¦ä¸å‡ºä¾†...",
                "æ€éº¼çŸ¥é“å°ä¸å°ï¼Ÿ",
                "ä»€éº¼æ™‚å€™ç”¨åå­—äº¤ä¹˜ï¼Ÿ"
            ];

            // é—œéµå­—å›ç­”é‚è¼¯
            const getAIResponse = (query) => {
                const q = query.toLowerCase();
                
                if (q.includes("ç¬¦è™Ÿ") || q.includes("æ­£è² ") || q.includes("åŠ æ¸›")) {
                    return "å£è¨£è¨˜èµ·ä¾†ï¼š\n1. çœ‹å°¾å·´(å¸¸æ•¸é …)ï¼š\n   ğŸ‘‰ æ­£æ•¸(+)ï¼šå…©å€‹æ‹¬è™Ÿã€ŒåŒè™Ÿã€ã€‚(ä¸­é–“æ­£å°±å…¨æ­£ï¼Œä¸­é–“è² å°±å…¨è² )\n   ğŸ‘‰ è² æ•¸(-)ï¼šå…©å€‹æ‹¬è™Ÿã€Œç•°è™Ÿã€ã€‚(å¤§æ•¸è·Ÿè‘—ä¸­é–“é …çš„ç¬¦è™Ÿ)\n2. é€™æ¨£å°±ä¸æœƒäº‚æ‰å›‰ï¼";
                }
                if (q.includes("ä¿‚æ•¸") || q.includes("ä¸æ˜¯1") || q.includes("é ­")) {
                    return "ç•¶ xÂ² å‰é¢æœ‰æ•¸å­—(ä¾‹å¦‚ 2xÂ²)æ™‚ï¼Œé ­ä¹Ÿè¦æ‹†å–”ï¼\nğŸ‘‰ 2xÂ² åªèƒ½æ‹†æˆ 2x å’Œ xã€‚\né€™æ™‚å€™ã€Œä½ç½®ã€å¾ˆé‡è¦ï¼Œå¸¸æ•¸é …æ”¾åœ¨ä¸Šæ’æˆ–ä¸‹æ’ï¼Œäº¤å‰ç›¸ä¹˜çš„çµæœæœƒä¸ä¸€æ¨£ï¼Œè¦å¤šè©¦å¹¾æ¬¡ï¼";
                }
                if (q.includes("è©¦") || q.includes("é›£") || q.includes("æ‹†ä¸å‡ºä¾†")) {
                    return "åˆ¥ç°å¿ƒï¼åå­—äº¤ä¹˜æœ¬ä¾†å°±æ˜¯ã€Œè©¦èª¤æ³•ã€(Trial and Error)ã€‚\nğŸ’¡ å°æŠ€å·§ï¼š\n1. å…ˆæŠŠæ‰€æœ‰èƒ½æ‹†çš„çµ„åˆåˆ—å‡ºä¾†ã€‚\n2. ç”¨å¿ƒç®—å¿«é€Ÿæª¢æŸ¥ä¸­é–“é …ã€‚\n3. å¦‚æœçœŸçš„æ‹†ä¸å‡ºä¾†ï¼Œæª¢æŸ¥ä¸€ä¸‹é¡Œç›®æœ‰æ²’æœ‰æŠ„éŒ¯ï¼Œæˆ–æ˜¯é€™é¡Œå¯èƒ½è¦ç”¨å…¬å¼è§£ï¼Ÿ";
                }
                if (q.includes("é©—ç®—") || q.includes("å°ä¸å°") || q.includes("æª¢æŸ¥")) {
                    return "é©—ç®—æœ€æº–çš„æ–¹æ³•å°±æ˜¯ã€Œä¹˜é–‹å®ƒã€ï¼\nåˆ©ç”¨åˆ†é…å¾‹æŠŠä½ çš„ç­”æ¡ˆå±•é–‹ï¼Œçœ‹çœ‹æœ‰æ²’æœ‰ç­‰æ–¼åŸæœ¬çš„é¡Œç›®ï¼Ÿ\nå¦‚æœæœ‰ï¼Œæ­å–œä½ ç­”å°å•¦ï¼ğŸ‰";
                }
                 if (q.includes("ä»€éº¼æ™‚å€™") || q.includes("æ™‚æ©Ÿ")) {
                    return "ç•¶ä½ çœ‹åˆ°äºŒæ¬¡ä¸‰é …å¼ (axÂ² + bx + c) æ™‚ï¼Œç¬¬ä¸€æ‹›å…ˆçœ‹æœ‰æ²’æœ‰å…¬å› å¼ï¼Œç¬¬äºŒæ‹›å°±æ˜¯ç”¨åå­—äº¤ä¹˜ï¼å®ƒæ˜¯æœ€å¸¸ç”¨çš„å› å¼åˆ†è§£å¤§æ‹›å–”ã€‚";
                }
                return "é€™å€‹å•é¡Œå•å¾—å¥½ï¼ä¸éæˆ‘ä¸»è¦å°ˆç²¾æ–¼åå­—äº¤ä¹˜æ³•çš„æŠ€å·§ã€‚\nä½ å¯ä»¥è©¦è©¦çœ‹å•æˆ‘ã€Œç¬¦è™Ÿæ€éº¼çœ‹ã€æˆ–æ˜¯ã€Œæ€éº¼é©—ç®—ã€å–”ï¼ğŸ¤–";
            };

            const handleSend = (text) => {
                if (!text.trim()) return;
                
                // User message
                setMessages(prev => [...prev, { type: 'user', text: text }]);
                setInputValue("");

                // Simulate AI thinking
                setTimeout(() => {
                    const response = getAIResponse(text);
                    setMessages(prev => [...prev, { type: 'bot', text: response }]);
                }, 600);
            };

            return (
                <>
                    {/* Floating Button */}
                    <button 
                        onClick={() => setIsOpen(!isOpen)}
                        className="absolute bottom-4 right-4 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full shadow-lg z-50 flex items-center gap-2 transition-transform hover:scale-105"
                    >
                        {isOpen ? <X size={24} /> : <MessageCircle size={24} />}
                        <span className="font-bold pr-1">{isOpen ? "é—œé–‰" : "AI å¹«å¹«æˆ‘"}</span>
                    </button>

                    {/* Chat Window */}
                    {isOpen && (
                        <div className="absolute bottom-16 right-4 w-80 sm:w-96 bg-white rounded-xl shadow-2xl border border-gray-200 flex flex-col z-40 overflow-hidden chat-pop" style={{height: '450px', maxHeight: '70vh'}}>
                            {/* Header */}
                            <div className="bg-blue-600 p-3 text-white flex items-center gap-2">
                                <Bot size={20} />
                                <span className="font-bold">æ•¸å­¸å°å®¶æ•™</span>
                            </div>

                            {/* Messages Area */}
                            <div className="flex-1 overflow-y-auto p-4 bg-gray-50 space-y-4">
                                {messages.map((msg, idx) => (
                                    <div key={idx} className={`flex ${msg.type === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[85%] p-3 rounded-lg text-sm whitespace-pre-wrap ${
                                            msg.type === 'user' 
                                                ? 'bg-blue-600 text-white rounded-tr-none' 
                                                : 'bg-white border border-gray-200 text-gray-800 rounded-tl-none shadow-sm'
                                        }`}>
                                            {msg.text}
                                        </div>
                                    </div>
                                ))}
                                <div ref={messagesEndRef} />
                            </div>

                            {/* Quick Questions Chips */}
                            <div className="p-2 bg-white border-t border-gray-100 overflow-x-auto whitespace-nowrap scrollbar-hide">
                                <div className="flex gap-2 px-1">
                                    {quickQuestions.map((q, idx) => (
                                        <button 
                                            key={idx}
                                            onClick={() => handleSend(q)}
                                            className="px-3 py-1 bg-blue-50 text-blue-700 text-xs rounded-full border border-blue-100 hover:bg-blue-100 transition-colors"
                                        >
                                            {q}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Input Area */}
                            <div className="p-3 bg-white border-t border-gray-200 flex gap-2">
                                <input 
                                    type="text" 
                                    value={inputValue}
                                    onChange={(e) => setInputValue(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleSend(inputValue)}
                                    placeholder="è¼¸å…¥å•é¡Œé—œéµå­—..."
                                    className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <button 
                                    onClick={() => handleSend(inputValue)}
                                    className="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
                                    disabled={!inputValue.trim()}
                                >
                                    <Send size={18} />
                                </button>
                            </div>
                        </div>
                    )}
                </>
            );
        };

        // --- ä¸»ç¨‹å¼é–‹å§‹ ---

        const CrossMultiplicationLesson = () => {
            const [currentSlide, setCurrentSlide] = useState(0);

            // Math styling helper
            const Super = ({ children }) => <sup className="text-sm">{children}</sup>;

            // Slide 1: Intro
            const IntroSlide = () => (
                <div className="flex flex-col items-center justify-center h-full text-center space-y-4 py-4">
                <div className="bg-blue-100 p-4 rounded-full mb-2 animate-bounce">
                    <BookOpen size={48} className="text-blue-600" />
                </div>
                <h1 className="text-3xl font-bold text-gray-800 mb-1">åå­—äº¤ä¹˜æ³•</h1>
                <h2 className="text-xl text-blue-600 font-semibold">å› å¼åˆ†è§£çš„æ ¸å¿ƒæŠ€å·§</h2>
                <p className="text-gray-600 max-w-lg text-base">
                    é€™æ˜¯ä¸€ç¨®ã€Œé€†å‘æ€è€ƒã€çš„è—è¡“ã€‚<br/>
                    æˆ‘å€‘è¦æ‰¾å‡ºå…©å€‹æ‹¬è™Ÿï¼Œè®“å®ƒå€‘ä¹˜é–‹å¾Œå›åˆ°åŸæœ¬çš„é¡Œç›®ã€‚
                </p>
                <div className="bg-yellow-50 border-l-4 border-yellow-400 p-3 text-left max-w-md mt-4 mx-auto shadow-sm">
                    <p className="font-bold text-yellow-800 flex items-center gap-2 text-sm">
                    <Edit3 size={16}/> å­¸ç¿’é‡é»ï¼š
                    </p>
                    <ul className="list-disc pl-5 text-gray-700 space-y-1 mt-1 text-sm">
                    <li>å­¸æœƒåå­—äº¤ä¹˜çš„æ›¸å¯«æ ¼å¼</li>
                    <li><strong>è©¦èª¤æ³•</strong>ï¼šå­¸æœƒåˆ—å‡ºæ‰€æœ‰å¯èƒ½æ€§ä¸¦æª¢æŸ¥</li>
                    <li>åˆ¤æ–·ç¬¦è™Ÿï¼ˆæ­£è² è™Ÿï¼‰</li>
                    </ul>
                </div>
                </div>
            );

            // Slide 2: Concept with Fixed Alignment
            const ConceptSlide = () => (
                <div className="flex flex-col items-center justify-center h-full py-4">
                <h2 className="text-2xl font-bold mb-6 text-gray-800">æ ¼å¼æ€éº¼å¯«ï¼Ÿ</h2>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-center w-full max-w-4xl px-4">
                    {/* Left: Standard Form */}
                    <div className="bg-white p-4 rounded-xl shadow-lg border border-gray-200">
                    <h3 className="text-base font-bold text-gray-500 mb-2 text-center">ç›®æ¨™å¤šé …å¼</h3>
                    <div className="text-3xl font-serif text-center py-2 bg-gray-50 rounded-lg">
                        ax<Super>2</Super> + bx + c
                    </div>
                    </div>

                    {/* Right: The Cross - FIXED LAYOUT */}
                    <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200 relative">
                    <h3 className="text-base font-bold text-gray-500 mb-4 text-center">åå­—äº¤ä¹˜åœ–ç¤º</h3>
                    
                    {/* Container with fixed width for perfect alignment */}
                    <div className="w-[200px] mx-auto relative">
                        <div className="flex justify-between text-2xl font-serif mb-8 relative z-10">
                        <div className="text-blue-600 w-12 text-center">dx</div>
                        <div className="text-green-600 w-12 text-center">p</div>
                        </div>

                        {/* SVG Overlay */}
                        <svg className="absolute top-3 left-0 w-full h-[90px] pointer-events-none" style={{zIndex: 0}}>
                        <line x1="25" y1="10" x2="175" y2="80" stroke="#CBD5E1" strokeWidth="4" />
                        <line x1="25" y1="80" x2="175" y2="10" stroke="#CBD5E1" strokeWidth="4" />
                        </svg>

                        <div className="flex justify-between text-2xl font-serif relative z-10">
                        <div className="text-blue-600 w-12 text-center">ex</div>
                        <div className="text-green-600 w-12 text-center">q</div>
                        </div>
                    </div>
                    
                    <div className="mt-4 pt-2 border-t border-gray-100 text-center">
                        <p className="text-gray-600 text-xs">æª¢é©—ä¸­é–“é …ï¼š</p>
                        <p className="text-lg font-bold text-red-500 mt-1">
                        (dx â€¢ q) + (ex â€¢ p) = bx
                        </p>
                    </div>
                    </div>
                </div>
                </div>
            );

            // Improved StepByStep Problem with Trial Phase
            const StepByStepProblem = ({ title, problem, trials, correctTrialIndex, steps, explanation }) => {
                const [step, setStep] = useState(0);

                const nextStep = () => setStep(prev => prev + 1);
                const reset = () => setStep(0);

                const isTrialPhase = step === 2 || step === 3;
                const isFinalPhase = step >= 4;

                return (
                <div className="flex flex-col w-full max-w-5xl mx-auto h-full px-2 py-2">
                    <h2 className="text-xl font-bold text-gray-800 mb-2 text-center md:text-left flex-shrink-0">{title}</h2>
                    <div className="bg-slate-800 text-white p-3 rounded-lg text-center text-2xl font-serif mb-4 tracking-wider shadow-md flex-shrink-0">
                    {problem}
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-4 flex flex-col lg:flex-row gap-4 flex-1 min-h-0 overflow-hidden">
                    
                    {/* Left: Interactive Area */}
                    <div className="flex-1 flex flex-col items-center pt-2 relative overflow-y-auto lg:overflow-visible">
                        
                        {/* 1. Head Split */}
                        <div className={`transition-all duration-500 mb-6 ${step >= 1 ? 'opacity-100' : 'opacity-0'}`}>
                            <div className="text-center mb-2 text-gray-400 text-xs font-bold tracking-widest uppercase">ç¬¬ä¸€æ­¥ï¼šæ‹†é ­</div>
                            <div className="flex flex-col items-center gap-6">
                            <div className="text-2xl font-serif text-blue-600 font-bold bg-blue-50 px-4 py-2 rounded border border-blue-100">{steps[0].head1}</div>
                            <div className="text-2xl font-serif text-blue-600 font-bold bg-blue-50 px-4 py-2 rounded border border-blue-100">{steps[0].head2}</div>
                            </div>
                        </div>

                        {/* 2. Trial Phase Area */}
                        {isTrialPhase && (
                        <div className="absolute top-16 w-full max-w-sm bg-white z-10 animate-in fade-in slide-in-from-bottom-4 duration-500">
                            <div className="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-3 shadow-lg">
                            <div className="flex items-center justify-center gap-2 text-yellow-800 font-bold mb-2 text-sm">
                                <HelpCircle size={18} />
                                <span>æ€è€ƒï¼šå°¾æ•¸å¯ä»¥æ€éº¼æ‹†ï¼Ÿ</span>
                            </div>
                            
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                {trials.map((trial, idx) => (
                                <div key={idx} className={`relative p-2 rounded-lg border-2 transition-all duration-500 flex justify-between items-center
                                    ${step === 3 
                                    ? (idx === correctTrialIndex 
                                        ? 'border-green-500 bg-green-50 scale-105 shadow-md' 
                                        : 'border-red-100 bg-red-50 opacity-50')
                                    : 'border-gray-200 bg-white'
                                    }
                                `}>
                                    <div className="font-serif text-base text-gray-700">
                                    {trial.pair}
                                    </div>
                                    
                                    {step === 3 && (
                                    <div className="flex items-center">
                                        {idx === correctTrialIndex ? (
                                        <Check className="text-green-600" size={20} />
                                        ) : (
                                        <div className="flex items-center text-red-400">
                                            <span className="text-[10px] mr-1 font-serif">{trial.sum}</span>
                                            <X size={20} />
                                        </div>
                                        )}
                                    </div>
                                    )}
                                    
                                    {/* Strikethrough line for wrong answers */}
                                    {step === 3 && idx !== correctTrialIndex && (
                                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                        <div className="w-[90%] h-[2px] bg-red-400 opacity-60 rotate-[-5deg]"></div>
                                    </div>
                                    )}
                                </div>
                                ))}
                            </div>
                            {step === 2 && <div className="text-center text-xs text-gray-500 mt-2">é»æ“Šä¸‹ä¸€æ­¥ä¾†æª¢æŸ¥è©¦èª¤...</div>}
                            </div>
                        </div>
                        )}

                        {/* 3. Final Cross Diagram (Replaces Trials) */}
                        {isFinalPhase && (
                            <div className="absolute top-0 w-full flex flex-col items-center animate-in zoom-in duration-500">
                            {/* Correct Pair Visualization - FIXED ALIGNMENT */}
                            <div className="w-[200px] relative mt-2">
                                {/* Text Row 1 */}
                                <div className="flex justify-between text-3xl font-serif mb-12 relative z-10 px-4">
                                <div className="text-blue-600 font-bold">{steps[0].head1}</div>
                                <div className="text-green-600 font-bold">{steps[1].tail1}</div>
                                </div>

                                {/* SVG Lines */}
                                <svg className="absolute top-3 left-0 w-full h-[100px] pointer-events-none z-0">
                                    {/* Connecting centers of text roughly */}
                                    <line x1="30" y1="15" x2="170" y2="85" stroke="#94A3B8" strokeWidth="4" />
                                    <line x1="30" y1="85" x2="170" y2="15" stroke="#94A3B8" strokeWidth="4" />
                                </svg>

                                {/* Text Row 2 */}
                                <div className="flex justify-between text-3xl font-serif relative z-10 px-4">
                                <div className="text-blue-600 font-bold">{steps[0].head2}</div>
                                <div className="text-green-600 font-bold">{steps[1].tail2}</div>
                                </div>
                            </div>

                            {/* Check Sum */}
                            <div className="mt-4 p-2 rounded-lg bg-red-50 border border-red-100 animate-in slide-in-from-bottom-2 fade-in duration-700">
                                <p className="text-xs text-red-400 mb-1 font-bold uppercase tracking-widest text-center">CHECK</p>
                                <p className="text-lg font-serif text-red-600 text-center font-bold">
                                {steps[2].check}
                                </p>
                            </div>

                            {/* Final Answer */}
                            {step >= 5 && (
                                <div className="mt-4 bg-green-100 px-6 py-3 rounded-xl text-center border-2 border-green-500 shadow-lg animate-in bounce-in duration-700">
                                <span className="text-green-800 font-bold block text-xs mb-1">å› å¼åˆ†è§£çµæœï¼š</span>
                                <span className="text-2xl font-serif font-bold text-green-900">{steps[3].result}</span>
                                </div>
                            )}
                            </div>
                        )}
                    </div>

                    {/* Right: Explanation Sidebar */}
                    <div className="w-full lg:w-64 bg-gray-50 rounded-xl p-4 border border-gray-200 flex flex-col flex-shrink-0 h-auto lg:h-full">
                        <h3 className="text-xs font-bold text-gray-400 uppercase mb-3 tracking-wider flex items-center gap-2">
                        <Calculator size={14}/> è§£é¡Œæ­¥é©Ÿ
                        </h3>
                        <div className="space-y-2 flex-1 overflow-y-auto min-h-[100px]">
                        {/* Custom Timeline */}
                        <TimelineItem active={step >= 1} current={step === 1} text={explanation[0]} />
                        <TimelineItem active={step >= 2} current={step === 2 || step === 3} text="åˆ—å‡ºå°¾æ•¸çš„æ‰€æœ‰å¯èƒ½çµ„åˆ" isTrial />
                        <TimelineItem active={step >= 4} current={step === 4} text={explanation[2]} />
                        <TimelineItem active={step >= 5} current={step === 5} text={explanation[3]} />
                        </div>

                        <div className="mt-4 pt-3 border-t border-gray-200">
                        {step < 5 ? (
                            <button 
                            onClick={nextStep}
                            className="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 group text-sm"
                            >
                            {step === 3 ? "ç¢ºèªé¸å®šçµ„åˆ" : "ä¸‹ä¸€æ­¥"} 
                            <ArrowRight size={16} className="group-hover:translate-x-1 transition-transform"/>
                            </button>
                        ) : (
                            <button 
                            onClick={reset}
                            className="w-full py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-bold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 text-sm"
                            >
                            é‡ä¾†ä¸€æ¬¡ <RefreshCw size={16} />
                            </button>
                        )}
                        </div>
                    </div>
                    </div>
                </div>
                );
            };

            const TimelineItem = ({ active, current, text, isTrial }) => (
                <div className={`flex gap-2 transition-all duration-300 ${active ? 'opacity-100' : 'opacity-40'}`}>
                <div className="flex flex-col items-center">
                    <div className={`w-2 h-2 rounded-full mt-1.5 ${current ? 'bg-blue-500 scale-125 ring-2 ring-blue-100' : (active ? 'bg-green-500' : 'bg-gray-300')}`}></div>
                    <div className={`w-0.5 h-full mt-1 ${active ? 'bg-gray-300' : 'bg-gray-200'}`}></div>
                </div>
                <div className={`pb-2 text-xs ${current ? 'font-bold text-blue-800' : 'text-gray-600'}`}>
                    {text}
                    {isTrial && current && <div className="text-[10px] text-orange-500 mt-1 font-normal">æ‰¾å‡ºäº¤å‰ç›¸ä¹˜å¾Œç­‰æ–¼ä¸­é–“é …çš„é‚£çµ„ã€‚</div>}
                </div>
                </div>
            );

            const slides = [
                {
                type: "intro",
                content: <IntroSlide />
                },
                {
                type: "concept",
                content: <ConceptSlide />
                },
                {
                type: "problem",
                title: "Level 1: åŸºç¤é¡Œ (è©¦èª¤é«”é©—)",
                problem: <span>x<Super>2</Super> + 5x + 6</span>,
                explanation: [
                    "æ‹†é ­ï¼šxÂ² æ‹†æˆ x å’Œ x",
                    "æ€è€ƒï¼š6 å¯ä»¥æ€éº¼æ‹†ï¼Ÿ",
                    "é©—ç®—ï¼šæ‰¾å‡ºç›¸åŠ ç­‰æ–¼ 5x çš„çµ„åˆ",
                    "å¯«å‡ºç­”æ¡ˆï¼š(x+2)(x+3)"
                ],
                // New Data for Trials
                trials: [
                    { pair: "1, 6", sum: "7x" },     // 1x + 6x = 7x
                    { pair: "-1, -6", sum: "-7x" },  // -1x - 6x = -7x
                    { pair: "2, 3", sum: "5x" },     // 2x + 3x = 5x (Correct)
                    { pair: "-2, -3", sum: "-5x" }   // -2x - 3x = -5x
                ],
                correctTrialIndex: 2, // Index of correct pair in trials array
                steps: [
                    { head1: "x", head2: "x" },
                    { tail1: "+2", tail2: "+3" },
                    { check: "2x + 3x = 5x (ç¬¦åˆ)" },
                    { result: "(x + 2)(x + 3)" }
                ]
                },
                {
                type: "problem",
                title: "Level 2: è² è™Ÿåˆ¤æ–·é¡Œ",
                problem: <span>x<Super>2</Super> - 7x + 12</span>,
                explanation: [
                    "æ‹†é ­ï¼šx æ‹†æˆ x å’Œ x",
                    "æ€è€ƒï¼š12 æ‹†æˆåŒè™Ÿæ•¸ï¼Œæ¹Š -7",
                    "é©—ç®—ï¼šè² è² å¾—æ­£ï¼Œç›¸åŠ ç‚ºè² ",
                    "å¯«å‡ºç­”æ¡ˆï¼š(x-3)(x-4)"
                ],
                trials: [
                    { pair: "3, 4", sum: "7x" },
                    { pair: "-3, -4", sum: "-7x" }, // Correct
                    { pair: "2, 6", sum: "8x" },
                    { pair: "-2, -6", sum: "-8x" }
                ],
                correctTrialIndex: 1,
                steps: [
                    { head1: "x", head2: "x" },
                    { tail1: "-3", tail2: "-4" },
                    { check: "-3x + (-4x) = -7x (ç¬¦åˆ)" },
                    { result: "(x - 3)(x - 4)" }
                ]
                },
                {
                type: "problem",
                title: "Level 3: ç•°è™Ÿç›¸åŠ  (å¸¸æ•¸è² )",
                problem: <span>x<Super>2</Super> + 2x - 15</span>,
                explanation: [
                    "æ‹†é ­",
                    "æ€è€ƒï¼š-15 æ˜¯ä¸€æ­£ä¸€è² ï¼Œå·®è¦ç‚º +2",
                    "é©—ç®—ï¼šå¤§æ•¸é…æ­£è™Ÿ",
                    "å¯«å‡ºç­”æ¡ˆ"
                ],
                trials: [
                    { pair: "1, -15", sum: "-14x" },
                    { pair: "-1, 15", sum: "14x" },
                    { pair: "3, -5", sum: "-2x" },
                    { pair: "-3, 5", sum: "2x" } // Correct
                ],
                correctTrialIndex: 3,
                steps: [
                    { head1: "x", head2: "x" },
                    { tail1: "+5", tail2: "-3" },
                    { check: "5x + (-3x) = 2x (ç¬¦åˆ)" },
                    { result: "(x + 5)(x - 3)" }
                ]
                }
            ];

            return (
                <div className="flex flex-col h-full bg-gray-50 text-gray-900 font-sans lesson-container">
                {/* Header */}
                <header className="bg-white border-b border-gray-200 px-6 py-3 flex justify-between items-center shadow-sm flex-shrink-0 z-10">
                    <div className="flex items-center gap-2">
                    <Calculator className="text-blue-600" />
                    <span className="font-bold text-lg hidden sm:inline">æ•¸å­¸å–®å…ƒ 3-2</span>
                    <span className="font-bold text-lg sm:hidden">3-2 åå­—äº¤ä¹˜</span>
                    </div>
                    <div className="flex items-center gap-4 text-sm text-gray-500">
                    <div className="w-24 sm:w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div 
                        className="h-full bg-blue-600 transition-all duration-300" 
                        style={{ width: `${((currentSlide + 1) / slides.length) * 100}%` }}
                        ></div>
                    </div>
                    <span>{currentSlide + 1} / {slides.length}</span>
                    </div>
                </header>

                {/* Main Content Area - Scrollable */}
                <main className="flex-1 overflow-hidden bg-gray-50">
                    <div className="w-full max-w-6xl mx-auto p-2 h-full flex flex-col justify-center">
                    <div className="transition-opacity duration-300 w-full h-full">
                        {slides[currentSlide].type === 'problem' ? (
                        <StepByStepProblem 
                            title={slides[currentSlide].title}
                            problem={slides[currentSlide].problem}
                            steps={slides[currentSlide].steps}
                            trials={slides[currentSlide].trials}
                            correctTrialIndex={slides[currentSlide].correctTrialIndex}
                            explanation={slides[currentSlide].explanation}
                        />
                        ) : (
                        slides[currentSlide].content
                        )}
                    </div>
                    </div>
                </main>

                {/* AI Tutor Floating Component */}
                <AITutor />

                {/* Navigation Footer */}
                <footer className="bg-white border-t border-gray-200 p-3 flex justify-center items-center gap-6 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] flex-shrink-0 z-10">
                    <button 
                    onClick={() => setCurrentSlide(Math.max(0, currentSlide - 1))}
                    disabled={currentSlide === 0}
                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all ${
                        currentSlide === 0 
                        ? 'bg-gray-100 text-gray-400 cursor-not-allowed' 
                        : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 hover:shadow-md'
                    }`}
                    >
                    <ArrowLeft size={18} /> <span className="hidden sm:inline text-sm">ä¸Šä¸€é </span>
                    </button>

                    <span className="font-bold text-gray-500 text-sm min-w-[100px] text-center">
                    {slides[currentSlide].title || "æ•™å­¸è§£èªª"}
                    </span>

                    <button 
                    onClick={() => setCurrentSlide(Math.min(slides.length - 1, currentSlide + 1))}
                    disabled={currentSlide === slides.length - 1}
                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all ${
                        currentSlide === slides.length - 1
                        ? 'bg-gray-100 text-gray-400 cursor-not-allowed' 
                        : 'bg-blue-600 text-white hover:bg-blue-700 shadow-md hover:shadow-lg'
                    }`}
                    >
                    <span className="hidden sm:inline text-sm">ä¸‹ä¸€é </span> <ArrowRight size={18} />
                    </button>
                </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CrossMultiplicationLesson />);
    </script>
</body>
</html>
